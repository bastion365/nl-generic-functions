services:
  nginx:
    image: nginx:1.29
    profiles: ["address-book"]
    ports:
      - 8080:8080
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro

  admin-directory:
    image: hapiproject/hapi:v8.2.0-2
    profiles: ["address-book"]
    ports:
      - 8081:8080
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - hapi.fhir.default_encoding=JSON
      - hapi.fhir.fhir_version=R4
      - hapi.fhir.implementationguides[0].name=hl7.fhir.r4.core
      - hapi.fhir.implementationguides[0].version=4.0.1
      - hapi.fhir.implementationguides[0].install-mode=STORE_AND_INSTALL
      - hapi.fhir.implementationguides[0].validation-mode=IGNORE
      - hapi.fhir.server_address=http://localhost:8080/admin-directory
      - hapi.fhir.tester.home.server_address=http://host.docker.internal:8080/admin-directory
      - spring.profiles.active=hapi

  query-directory:
    image: hapiproject/hapi:v8.0.0
    profiles: ["address-book"]
    ports:
      - 8082:8080
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - hapi.fhir.server_address=http://localhost:8080/query-directory
      - hapi.fhir.tester.home.server_address=http://host.docker.internal:8080/query-directory

  lrza-mock:
    image: hapiproject/hapi:v8.0.0
    profiles: ["address-book"]
    ports:
      - 8083:8080
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - hapi.fhir.server_address=http://localhost:8080/lrza-mock
      - hapi.fhir.tester.home.server_address=http://host.docker.internal:8080/lrza-mock
      - hapi.store-resource-delete-versions=true

  update-client:
    build:
      context: .
      additional_contexts:
        monorepo: .
        common: ./common
        address-book: ./address-book
      dockerfile: ./address-book/update-client/Dockerfile
      args:
        NODE_VERSION: "22.12"
        OS_VERSION: bookworm
        NODE_ENV: development
    profiles: ["aux"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    tty: true # To display colours in docker compose logs
    environment:
      - LRZA_BASE_URL=http://host.docker.internal:8080/lrza-mock
      - QUERY_DIRECTORY_BASE_URL=http://host.docker.internal:8080/query-directory
    volumes:
      - update-client-status:/var/status

  address-book-seeder:
    build:
      context: ./address-book/seeder
    profiles: ["address-book"]
    environment:
      - ADMIN_DIRECTORY_BASE_URL=http://admin-directory:8080/fhir
      - LRZA_MOCK_BASE_URL=http://lrza-mock:8080/fhir
    volumes:
      - ./address-book/seeder:/seeder

  demo-client:
    build:
      context: .
      additional_contexts:
        monorepo: .
        common: ./common
        demo-client: ./demo-client
      dockerfile: ./demo-client/Dockerfile
      args:
        NODE_VERSION: "22.12"
        OS_VERSION: bookworm
        NODE_ENV: development
    profiles: ["address-book"]
    ports:
      - 8090:8080
    entrypoint: ["node", "--watch", "--watch-path=demo-client/public", "--watch-path=demo-client/src", "--watch-path=demo-client/templates", "./demo-client/src/app.js"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    tty: true # To display colours in docker compose logs
    environment:
      - ADMIN_DIRECTORY_BASE_URL=http://host.docker.internal:8080/admin-directory
      - EHR_BASE_URL=http://host.docker.internal:8080/ehr
      - QUERY_DIRECTORY_BASE_URL=http://host.docker.internal:8080/query-directory
    volumes:
      - ./package.json:/home/node/package.json
      - ./package-lock.json:/home/node/package-lock.json
      - ./demo-client:/home/node/demo-client
      - ./common/fetch:/home/node/common/fetch
      - ./common/fhir-client:/home/node/common/fhir-client
      - ./common/oplog:/home/node/common/oplog

  address-book-test:
    build:
      context: .
      additional_contexts:
        monorepo: .
        common: ./common
        address-book: ./address-book
      dockerfile: ./address-book/test/Dockerfile
    profiles: ["test"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - ADMIN_DIRECTORY_BASE_URL=http://host.docker.internal:8080/admin-directory
      - QUERY_DIRECTORY_BASE_URL=http://host.docker.internal:8080/query-directory
      - LRZA_MOCK_BASE_URL=http://host.docker.internal:8080/lrza-mock
      - DOCKER_BUILDKIT=1
      - COMPOSE_DOCKER_CLI_BUILD=1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/home/node
      - /home/node/node_modules

  ehr:
    image: hapiproject/hapi:v8.0.0
    ports:
      - 8084:8080
    volumes:
      - ./eoverdracht/config/hapi.application.yaml:/data/hapi/application.yaml:ro
    environment:
      SPRING_CONFIG_LOCATION: "file:///data/hapi/application.yaml"
    depends_on:
      - ehr-postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/fhir/metadata"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  ehr-postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: hapi
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d hapi"]
      interval: 10s
      timeout: 5s
      retries: 5

  ehr-seeder:
    build:
      context: ./eoverdracht/seeder
    environment:
      - FHIR_BASE_URL=http://ehr:8080/fhir
    depends_on:
      - ehr
    volumes:
      - ./eoverdracht/seeder/data:/seeder/data
      - ./eoverdracht/seeder/packages:/seeder/packages

volumes:
  postgres-data:
  update-client-status:
